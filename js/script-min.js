var Datastore=require('nedb'),db=new Datastore({filename:__dirname+'../db/data.db',autoload:!0});const fs=require('fs'),{dialog}=require('electron').remote,XLSX=require('xlsx');var json_global;$(document).ready(function(){pricing_view(),shipping_view(),etr_view(),cost_view()}),$('#multiple_checkbox').click(function(){return!0==$(this).prop('checked')?void $('#multiple_div').show():void $('#multiple_div').hide()});function upload(){dialog.showOpenDialog({filters:[{name:'excel',extensions:['xlsx']}]},a=>{void 0===a||(filepath=a[0],fs.readFile(filepath,'utf8',b=>{b||''==filepath||calculate(filepath)}))})}var get_all_channels=function(){return new Promise((a,b)=>{db.find({type:'pricing'},{channel_name:1},function(e,f){if(e)return void b(e);var g=[];for(var h of f)-1==g.indexOf(h.channel_name)&&g.push(h.channel_name);a(g)})})},get_pricing=function(a,b){return new Promise((e,f)=>{db.findOne({type:'pricing',channel_name:a,brand:b},function(g,h){if(null==h)return void f(g);var i=parseFloat(h.percentage),j=!1,k=10;(h.hasOwnProperty('exchange')||h.hasOwnProperty('tax'))&&(j=!0),h.hasOwnProperty('multiple')&&(k=parseFloat(h.multiple)),e([i,j,k])})})},get_cost=function(a,b){return new Promise((e,f)=>{db.find({type:'cost',channel_name:a},function(g,h){if(null==h)return void f(g);var i=0;for(var j of h)b>=parseFloat(j.min_cost_cost)&&b<parseFloat(j.max_cost_cost)&&(i=parseFloat(j.percent_cost));e(i)})})},get_shipping=function(a,b){return new Promise((e,f)=>{db.find({type:'shipping',channel_name:a},function(g,h){if(null==h)return void f(g);var i=0;for(var j of h)b>=parseFloat(j.min_cost)&&b<parseFloat(j.max_cost)&&(i=parseFloat(j.extra_cost));e(i)})})},get_etr=function(){return new Promise((b,e)=>{db.findOne({type:'etr',channel_name:each_channel},function(f,g){if(null==g)return void e(f);var h=etr_tx=1;return g.hasOwnProperty('exchange_rate')&&g.hasOwnProperty('tax_rate')?(h=parseFloat(g.exchange_rate),etr_tx=g.tax_rate,void b([h,etr_tx])):etr_res.hasOwnProperty('exchange_rate')?(h=parseFloat(g.exchange_rate),void b([h,etr_tx])):(etr_tx=parseFloat(g.tax_rate),void b([h,etr_tx]))})})};function sleep(a){return new Promise(b=>setTimeout(b,a))}async function calculate(a){var b=XLSX.readFile(a),e=b.Sheets[b.SheetNames[0]];json_global=XLSX.utils.sheet_to_json(e);var f=await get_all_channels(),g=1;if(0==json_global.length)return void fill_p('upload_p','warning','No Data in the input file');if(0==f.length)return void fill_p('upload_p','warning','No Channels found to calculate pricing');$('#progress_wrapper').show(),$('#progress').css('width','0%');for(var h of json_global){await sleep(100),delete h.Consignment,delete h.Warehouse;for(var i of f){var j;try{j=await get_pricing(i,h.Brand)}catch(n){try{j=await get_pricing(i,'Other')}catch(p){h[i]='NA';continue}}try{var k=await get_cost(i,parseFloat(h.CostUSD));0!=k&&(j[0]=k)}catch(n){}var l=parseFloat(h.CostUSD)*j[0]+parseFloat(h.CostUSD);try{l+=await get_shipping(i,parseFloat(h.CostUSD))}catch(n){}if(j[1])try{l*=multiply((await get_etr(i)))}catch(n){}h[i]=10==j[2]?Math.ceil(l):Math.ceil(l/m)*m,delete h.CostUSD}$('#progress').css('width',parseInt(100*(g/json_global.length))+'%'),$('#progress').html(parseInt(100*(g/json_global.length))+'% Complete'),g+=1}$('#save').show()}function save(){var a=XLSX.utils.json_to_sheet(json_global),b=XLSX.utils.book_new();XLSX.utils.book_append_sheet(b,a,'Pricing Result'),dialog.showSaveDialog({filters:[{name:'excel',extensions:['xlsx']}]},function(e){try{return'xlsx'===e.split('.').pop()?(XLSX.writeFile(b,e),-1<e.indexOf('\\')?void fill_p('upload_p','success','File Saved Successfully to '+e.substring(0,e.lastIndexOf('\\'))):-1<e.indexOf('/')?void fill_p('upload_p','success','File Saved Successfully to '+e.substring(0,e.lastIndexOf('/'))):void fill_p('upload_p','success','File Saved Successful')):void fill_p('upload_p','warning','Save unsuccessful. Please give extension as only "xlsx"')}catch(f){fill_p('upload_p','warning','Save unsuccessful')}})}function pricing_view(){$('#view_select_channel').empty(),db.find({type:'pricing'},{channel_name:1,_id:0},function(a,b){var e=[];b.forEach(function(i){-1==$.inArray(i.channel_name,e)&&e.push(i.channel_name)},this);var g=document.getElementById('view_select_channel');for(var h of e)option=document.createElement('option'),option.value=h,option.innerHTML=h,g.add(option);$('#view_select_channel').addClass('selectpicker'),$('#view_select_channel').attr('data-live-search','true','multiple','multiple'),$('#view_select_channel').selectpicker('refresh')})}function delete_pricing(){return $('#delete_pricing_p').html(''),''==$('#delete_pricing_brand').val().trim()||''==$('#delete_pricing_channel').val().trim()?void fill_p('delete_pricing_p','warning','Do not leave empty fields'):void db.find({type:'pricing',channel_name:$('#delete_pricing_channel').val().trim(),brand:$('#delete_pricing_brand').val().trim()},function(a,b){return 0==b.length?void fill_p('delete_pricing_p','warning','No such Channel or Brand Found'):void db.remove({type:'pricing',channel_name:$('#delete_pricing_channel').val().trim(),brand:$('#delete_pricing_brand').val().trim()},{multi:!0},function(e){return e?void fill_p('delete_pricing_p','warning','Pricing Formula Deletion Failed'):void fill_p('delete_pricing_p','success','Pricing Formula deleted successfully')})})}function add_new_pricing(){var a=get_data();!1==a||db.insert(a,function(b){if($('#fail').show(),!b)fill_p('fail','success','<b>New Pricing added</b>'),$('#new_pricing_form :input:not([type=checkbox])').val('');else if('uniqueViolated'==b.errorType)return void fill_p('fail','warning','<b>Pricing for '+a.brand+' in '+a.channel_name+' already there. Operations allowed are update and delete</b>')})}function update_pricing(){var a=get_data();!1==a||db.find({_id:a._id},function(b,e){return $('#fail').show(),0<e.length?void db.remove({_id:a._id},{multi:!0},function(f,g){return 0<g?void db.insert(a,function(h){return h?void fill_p('fail','error','Updation Failed'):(fill_p('fail','success','Update Successful'),void $('#new_pricing_form :input:not([type=checkbox])').val(''))}):void fill_p('fail','error','Updation Failed')}):void fill_p('fail','warning','No such Channel Found. Consider adding as a new channel')})}function check(){return''==$('#channel_name').val().trim()?($('#result_formula').html('*Please Enter a Channel Name'),!1):''!=$('#brand').val().trim()||($('#result_formula').html('*Please Enter a Brand Name'),!1)}function populate(){check()&&update()}function update(){var a='The pricing for <b> '+$('#channel_name').val().trim()+'</b> and <b> '+$('#brand').val().trim()+'</b> is : <b>';a+='Ceiling(';var b=10;$('#multiple_checkbox').is(':checked')&&(''==$('#multiple').val()?b=10:b=$('#multiple').val()),a+=''==$('#percentage').val()?'(Cost * (1 + Percentage Rate) + Shipping)':'(Cost * '+(1+parseFloat($('#percentage').val()))+' + Shipping)',$('#exchange_checkbox').prop('checked')&&(a+=' * Exchange Rate'),$('#tax_checkbox').prop('checked')&&(a+=' * Tax Rate'),$('#result_formula').html(a+', '+b+')</b>')}$('#percentage,#channel_name,#brand,#multiple').bind('keyup mouseup',function(){populate()}),$('#exchange_checkbox,#tax_checkbox,#multiple_checkbox').click(function(){populate()}),$('#min_cost,#max_cost,#extra_cost').bind('keyup mouseup',function(){shipping_populate()});function shipping_populate(){if(''==$('#channel_shipping').val().trim())return void $('#result_shipping').html('*Please enter the Channel Name');var a='Any Price greater than <b> $';a+=''==$('#min_cost').val()?'(Min_Cost)</b> and lesser than <b>$':$('#min_cost').val()+'</b> and lesser than <b>$',a+=''==$('#max_cost').val()?'(Max_Cost)</b> in <b>'+$('#channel_shipping').val().trim()+'</b> will be charged an extra cost of <b>$':$('#max_cost').val()+'</b> in <b>'+$('#channel_shipping').val().trim()+'</b> will be charged an extra cost of <b>$',a+=''==$('#extra_cost').val()?'(Extra_Cost)</b> ':$('#extra_cost').val()+'</b>',$('#result_shipping').html(a+'</b>')}function shipping_view(){$('#shipping_rules > tbody').html(''),db.find({type:'shipping'},{_id:0},function(a,b){b.forEach(function(e){$('#shipping_rules tbody').append('<tr><td class="text-center">'+e.channel_name+'</td><td class="text-center">['+e.min_cost+','+e.max_cost+') </td><td class="text-center">'+e.extra_cost+'</td></tr>')},this)}),$('#shipping_rules').show()}function cost_view(){$('#cost_rules > tbody').html(''),db.find({type:'cost'},{_id:0},function(a,b){b.forEach(function(e){$('#cost_rules tbody').append('<tr><td class="text-center">'+e.channel_name+'</td><td class="text-center">['+e.min_cost_cost+','+e.max_cost_cost+') </td><td class="text-center">'+e.percent_cost+'</td></tr>')},this)}),$('#cost_rules').show()}function fill_p(a,b,e){$('#'+a).removeClass();'warning'===b?$('#'+a).addClass('alert alert-warning'):'success'===b?$('#'+a).addClass('alert alert-success'):'error'===b?$('#'+a).addClass('alert alert-error'):void 0;$('#'+a).html('<b>'+e+'</b>'),$('#'+a).show()}function get_data(){var a={};$('#new_pricing_form :input[type=\'text\']').each(function(){return''==$(this).val().trim()?(fill_p('fail','warning','Do not leave the fields empty'),temp=!1,!1):void(a[$(this).prop('id')]=$(this).val())});var b=$('#percentage').val();if($('#multiple_checkbox').is(':checked')){if(''==$('#multiple').val())return void fill_p('fail','warning','Do not leave the fields empty');a.multiple=$('#multiple').val()}return''==b||''==multiple?void fill_p('fail','warning','Do not leave the fields empty'):(a.percentage=b,$('#exchange_checkbox').prop('checked')&&(a.exchange=!0),$('#tax_checkbox').prop('checked')&&(a.tax=!0),a._id='pricing'+a.channel_name.toLowerCase()+a.brand.toLowerCase(),a.type='pricing',a)}function search(){$('#table_view_search > tbody').html(''),db.find({type:'pricing',channel_name:$('#view_select_channel').val()},{_id:0},function(a,b){b.forEach(function(e){var f=10,g='<tr><td class="text-center">'+e.brand+'</td><td class="text-center">Ceiling((Cost * '+(1+parseFloat(e.percentage))+' + Shipping)';e.hasOwnProperty('exchange')&&(g+=' * Exchange Rate'),e.hasOwnProperty('tax')&&(g+=' * Tax Rate'),e.hasOwnProperty('multiple')&&(f=parseFloat(e.multiple)),$('#table_view_search tbody').append(g+', '+f+')</td></tr>')},this)}),$('#table_view_search').show()}function add_shipping_rule(){var a={},b=!0;if(parseFloat($('#min_cost').val())>parseFloat($('#max_cost').val()))return void $('#result_shipping').html('*Maximum Cost cannot be less than Minimum Cost');$('#new_shipping_form :input').each(function(){return''==$(this).val().trim()?(fill_p('shipping_p','warning','Do not leave the fields empty'),b=!1,!1):void(a[$(this).prop('id')]=$(this).val())});b&&(a.channel_name=a.channel_shipping,delete a.channel_shipping,a.type='shipping',a.min_cost=a.min_cost,a.max_cost=a.max_cost,a.extra_cost=a.extra_cost,db.insert(a,function(e){return e?void fill_p('shipping_p','warning','Error'):void fill_p('shipping_p','success','New Shipping Rule added')}),$('#new_shipping_form')[0].reset())}function add_cost_constraint(){var a={},b=!0;if(parseFloat($('#min_cost_cost').val())>parseFloat($('#max_cost_cost').val()))return void $('#result_cost').html('*Maximum Cost cannot be less than Minimum Cost');$('#new_cost_form :input').each(function(){return''==$(this).val().trim()?(fill_p('cost_p','warning','Do not leave the fields empty'),b=!1,!1):void(a[$(this).prop('id')]=$(this).val())});b&&(a.channel_name=a.channel_cost,delete a.channel_cost,a.type='cost',a.min_cost_cost=a.min_cost_cost,a.max_cost_cost=a.max_cost_cost,a.percent_cost=a.percent_cost,db.insert(a,function(e){if(!e)fill_p('cost_p','success','New Cost Constraint added');else if('uniqueViolated'==e.errorType)return void fill_p('cost_p','warning','Cost Constraint already there')}),$('#new_cost_form')[0].reset())}function delete_cost_constraint(){$('#delete_cost_p').html('');var a=$('#channel_delete_cost').val().trim();return''==a?void $('#delete_cost_p').html('Enter the Channel Name'):void db.find({type:'cost',channel_name:a},function(b,e){return 0==e.length?void fill_p('delete_cost_p','warning','No such Channel Found'):void db.remove({type:'cost',channel_name:a},{multi:!0},function(f){return f?void fill_p('delete_cost_p','warning','Cost Constraint Deletion Failed'):void fill_p('delete_cost_p','success','Cost Constraint deleted successfully')})})}function delete_shipping_rule(){$('#delete_shipping_p').html('');var a=$('#channel_delete').val().trim();return''==a?void $('#delete_shipping_p').html('Enter the Channel Name'):void db.find({type:'shipping',channel_name:a},function(b,e){return 0==e.length?void fill_p('delete_shipping_p','warning','No such Channel Found'):void db.remove({type:'shipping',channel_name:a},{multi:!0},function(f){return f?void fill_p('delete_shipping_p','warning','Shipping Rule Deletion Failed'):void fill_p('delete_shipping_p','success','Shipping Rule deleted successfully')})})}function etr_search(){$('#table_view_search_etr > tbody').html(''),db.find({type:'etr',channel_name:$('#view_select_channel_etr').val()},{_id:0},function(a,b){b.forEach(function(e){var f='<tr><td class="text-center">'+e.channel_name+'</td>';f+=e.hasOwnProperty('exchange_rate')?'<td class="text-center">'+e.exchange_rate+'</td>':'<td class="text-center">NA</td>',f+=e.hasOwnProperty('tax_rate')?'<td class="text-center">'+e.tax_rate+'</td>':'<td class="text-center">NA</td>',$('#table_view_search_etr tbody').append(f+'</td></tr>')},this)}),$('#table_view_search_etr').show()}function etr_view(){$('#view_select_channel_etr').empty(),db.find({type:'etr'},{channel_name:1,_id:0},function(a,b){var e=[];b.forEach(function(i){-1==$.inArray(i.channel_name,e)&&e.push(i.channel_name)},this);var g=document.getElementById('view_select_channel_etr');for(var h of e)option=document.createElement('option'),option.value=h,option.innerHTML=h,g.add(option);$('#view_select_channel_etr').addClass('selectpicker'),$('#view_select_channel_etr').attr('data-live-search','true','multiple','multiple'),$('#view_select_channel_etr ').selectpicker('refresh')})}function add_etr(){if(''==$('#channel_etr').val().trim())return void fill_p('etr_p','warning','Please Enter the Channel Name');if(''==$('#exchange_rate').val()&&''==$('#tax_rate').val())return void fill_p('etr_p','warning','DO NOT ADD IF EXCHANGE OR TAX RATE IS NOT NEEDED');var a={};a.type='etr',a.channel_name=$('#channel_etr').val().trim(),''==$('#exchange_rate').val()?a.tax_rate=$('#tax_rate').val():''==$('#tax_rate').val()?a.exchange_rate=$('#exchange_rate').val():(a.tax_rate=$('#tax_rate').val(),a.exchange_rate=$('#exchange_rate').val()),a._id='etr'+a.channel_name,db.insert(a,function(b){return b?void fill_p('etr_p','warning','Exchange and Tax Rate already exists. To update,delete and add.'):(fill_p('etr_p','success','Exchange and Tax Rate for the channel "'+a.channel_name+'" added'),void $('#etr_add_form')[0].reset())})}function delete_etr(){if(''==$('#channel_etr_delete').val().trim())return void fill_p('etr_p_delete','warning','Please Enter the Channel Name');var a={type:'etr',channel_name:$('#channel_etr_delete').val().trim()};db.find(a,function(b,e){return 0==e.length?void fill_p('etr_p_delete','warning','No such Channel Found'):void db.remove(a,{multi:!0},function(f){return f?void fill_p('etr_p_delete','warning','Exchange and Tax Rule Deletion Failed'):(fill_p('etr_p_delete','success','Exchange and Tax Rule deleted successfully'),void $('#etr_delete_form')[0].reset())})})}